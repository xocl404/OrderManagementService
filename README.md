# Order Management Service

## Отрабатываемый материал

Npgsql, Postgres, serialization, ASP.NET, hosted service, HTTP, gRPC, Реактивное межсервисное взаимодействие, Kafka

## Задание 1

Реализовать репозитории, миграцию и сервис для предоставленной [схемы данных](lab-3-task-1.sql).

### Функциональные требования

- Репозиторий товаров должен предоставлять функционал
    - Создания товаров
    - Пагинированного поиска товаров (фильтрация по: идентификаторам, минимальной и максимальной цене, подстроке в имени
      товара)
- Репозиторий заказов должен предоставлять функционал
    - Создания заказа
    - Изменения статуса заказа
    - Пагинированного поиска заказов (фильтрация по: идентификаторам, статусу, автору)
- Репозиторий позиций заказов должен предоставлять функционал
    - Добавление позиции заказа
    - Удаление позиции из заказа (soft delete)
    - Пагинированного поиска по позициям заказов (фильтрация по: идентификаторам заказов, идентификаторам товаров,
      признаку удаления [bool?])
- Репозиторий истории заказов должен предоставлять функционал
    - Добавление записи в историю заказа
    - Пагинированного поиска по истории заказов (фильтрация по: идентификаторам заказа, типу истории)
- Сервис товаров должен предоставлять функционал
    - Создания товаров
- Сервис заказов должен предоставлять функционал
    - Создания заказа
    - Добавления товаров в заказ (только для заказов в статусе `created`)
    - Удаление товаров из заказа (только для заказов в статусе `created`)
    - Перевод заказа в работу (статус `processing`)
    - Выполнение заказа (перевод в статус `completed`)
    - Отмену заказа (перевод в статус `cancelled`)
    - Пагинированного поиска по истории одного заказа
    - Все операции должны сопровождаться соответствующими записями в историю

### Нефункциональные требования

- Миграции должны быть реализованы через библиотеку FluentMigrator и SQL код
- Конфигурации базы данных должны быть получены через Microsoft.Extensions.Options
- Должны быть реализованы методы расширения для регистрации в DI миграций, репозиториев и подключений к базе данных
- Должен быть реализованы методы расширения для запуска миграций
- В репозитории истории заказов должна быть реализована полиморфная сериализация/десериализация записей истории
- Репозитории должны быть реализованы через SQL запросы и библиотеку Npgsql
- Операции сервиса, подразумевающие несколько запросов в базу данных, должны использовать транзакции
- Должен быть реализован метод расширения для регистрации сервисов в DI

## Задание 2

- Реализовать Presentation слой с использованием gRPC.

### Функциональные требования

- Presentation слой должен предоставлять весь функционал, реализуемый сервисом заказов

### Нефункциональные требования

- конфигурация клиента должна происходить через Options
- модели gRPC API, подразумевающие полиморфизм, должны быть реализованы через `oneof`
- должен быть реализован серверный Interceptor, отдающий сообщения об ошибках в определённом формате
- должно быть реализовано получение изначальной конфигурации и её последующая актуализация при помощи ASP.NET 
- код в Program.cs не должен явно выполнять какие-либо операции, он должен состоять только из настройки
  `builder.Services`, `builder.Configuration`, `app`

## Задание 3

Реализовать HTTP гейтвей (отдельный сервис) над gRPC сервисом.

### Нефункциональные требования

- HTTP гейтвей должен иметь Swagger документацию, аннотированную возможными возвращаемыми кодами
- модели, подразумевающие полиморфизм, в API HTTP гейтвея должны быть реализованы **НЕ** в виде `oneof`, а с использованием наследования
- Swagger документация должна корректно отображать полиморфные модели
- в HTTP гейтвее должен быть реализован middleware, для преобразования gRPC эксепшенов в конкретные HTTP коды
- модели HTTP гейтвея не должны в каком-либо виде завязываться на Proto модели
- должно быть реализовано получение изначальной конфигурации и её последующая актуализация при помощи ASP.NET
- код в Program.cs не должен явно выполнять какие-либо операции, он должен состоять только из настройки
  `builder.Services`, `builder.Configuration`, `app`

## Задание 4

Интегрировать сервис из заданий 1-3 с сервисом обработки заказов.

- начать писать в топик `order_creation`
- начать читать топик `order_processing`
- добавить эндпоинты сервиса обработки заказа на гейтвей

### Функциональные требования

- Ваш сервис должен читать топик `order_processing` и корректно обрабатывать его события
    - события, подразумевающие неудачный исход, при этом неудачном исходе должны переводить заказ в статус отменён в
      вашем сервисе
    - при получении событий о жизненном цикле заказа, ваш сервис должен записывать данные об этом в историю
- Ваш сервис должен писать в топик `order_creation` корректно обрабатывая свои операции
    - создание заказа должно приводить к записи сообщения об этом
    - перевод заказа в статус `processing` должен приводить к записи сообщения об этом
- Логика отмены заказов вашего сервиса должна быть переработана так, чтобы отмена была возможно только для заказов в
  статусе `created`
- После получения события об успешном завершении доставки заказа – заказ должен оказаться в статусе `completed`
- Вы должны убрать возможность перевести заказ в статус `completed` через ручки вашего сервиса

### Сценарий тестирования

- создание заказа (ваш сервис)
- перевод заказа в статус processing (ваш сервис)
- заказ согласуется* (сервис обработки заказов)
- начало упаковки заказа (сервис обработки заказов)
- завершение упаковки заказа* (сервис обработки заказов)
- начало доставки заказа (сервис обработки заказов)
- завершение доставки заказа* (сервис обработки заказов)

\* Данные операции сервиса обработки заказов могут завершиться неуспешно, ваш сервис должен уметь это обрабатывать.

### Нефункциональные требования

- Вы должны реализовать общие абстракции для записи в топики и чтения из них
    - для producer вы должны выделить интерфейс и реализовать его
    - для consumer вы должны выделить интерфейс обработчика сообщений, а также реализовать фоновый сервис вычитывающий
      сообщения
    - producer и consumer не должны завязываться на конкретные топики, они должны быть реализованы в отдельном проекте,
      должны иметь методы расширения для подключения
    - все параметры работы с kafka (подключение, названия топиков, размеры батчей) должны быть параметризованы через
      options
    - consumer должен реализовывать батчовую обработку сообщений
- Эндпоинты HTTP гейтвея, как новые, так и существующие, должны быть реализованы согласно конвенциям REST
